// import sharp from 'sharp';

// // Пример строки SVG водяного знака
// const watermarkSVG = `
// <svg width="430" height="430" viewBox="0 0 430 430" fill="none" xmlns="http://www.w3.org/2000/svg">
// <path d="M273.382 252.071C286.585 238.867 293.187 221.561 293.187 204.257C293.187 186.952 286.585 169.647 273.381 156.443C260.177 143.239 242.871 136.637 225.567 136.636C208.262 136.636 190.957 143.239 177.753 156.443C164.549 169.647 157.948 186.952 157.947 204.256C157.947 221.561 164.55 238.866 177.753 252.07C190.957 265.274 208.263 271.876 225.568 271.877C242.872 271.877 260.178 265.275 273.382 252.071ZM297.567 204.257C297.567 222.683 290.537 241.11 276.479 255.168C262.421 269.226 243.994 276.256 225.568 276.256C207.141 276.256 188.714 269.226 174.656 255.168C160.597 241.11 153.568 222.683 153.568 204.256C153.567 185.83 160.597 167.403 174.656 153.345C188.714 139.287 207.14 132.257 225.567 132.257C243.993 132.257 262.42 139.287 276.478 153.345C290.537 167.403 297.567 185.83 297.567 204.257Z" fill="white" fill-opacity="0.45"/>
// <path d="M218.656 206.231L262.589 250.164C255.594 255.335 252.717 257.734 243.503 261.024L197.43 214.951L199.076 210.344L218.656 206.23L218.656 206.231Z" fill="white" fill-opacity="0.45"/>
// <path d="M218.656 206.231L262.589 250.164C255.594 255.335 252.717 257.734 243.503 261.024L197.43 214.951L199.076 210.344L218.656 206.23L218.656 206.231Z" fill="white" fill-opacity="0.45"/>
// <path d="M225.897 158.843L246.958 179.905L238.238 181.714L230.669 202.118L197.102 169.209L198.767 164.582L225.897 158.843Z" fill="white" fill-opacity="0.45"/>
// <path d="M225.897 158.843L246.958 179.905L238.238 181.714L230.669 202.118L197.102 169.209L198.767 164.582L225.897 158.843Z" fill="white" fill-opacity="0.45"/>
// <path d="M259.135 178.917L284.145 203.927C283.82 214.632 282.337 218.649 278.868 228.033L278.715 228.444L237.909 187.638L239.555 183.03L259.135 178.916L259.135 178.917Z" fill="white" fill-opacity="0.45"/>
// <path d="M259.135 178.917L284.145 203.927C283.82 214.632 282.337 218.649 278.868 228.033L278.715 228.444L237.909 187.638L239.555 183.03L259.135 178.916L259.135 178.917Z" fill="white" fill-opacity="0.45"/>
// <path d="M231.656 203.763L239.389 183.195L240.705 188.789L235.44 203.597L272.133 240.291C271.578 241.101 271.172 241.538 270.159 242.265L231.656 203.762L231.656 203.763Z" fill="white" fill-opacity="0.45"/>
// <path d="M231.656 203.763L239.389 183.195L240.705 188.789L235.44 203.597L272.133 240.291C271.578 241.101 271.172 241.538 270.159 242.265L231.656 203.762L231.656 203.763Z" fill="white" fill-opacity="0.45"/>
// <path d="M191.508 230.748L199.241 210.181L200.557 216.105L195.127 231.078L228.035 263.986C226.903 264.333 226.257 264.427 225.073 264.315L191.507 230.748L191.508 230.748Z" fill="white" fill-opacity="0.45"/>
// <path d="M191.508 230.748L199.241 210.181L200.557 216.105L195.127 231.078L228.035 263.986C226.903 264.333 226.257 264.427 225.073 264.315L191.507 230.748L191.508 230.748Z" fill="white" fill-opacity="0.45"/>
// <path d="M188.71 191.093L198.746 164.602L200.063 170.197L193.481 189.284L209.935 205.738L204.341 206.725L188.71 191.093Z" fill="white" fill-opacity="0.45"/>
// <path d="M188.71 191.093L198.746 164.602L200.063 170.197L193.481 189.284L209.935 205.738L204.341 206.725L188.71 191.093Z" fill="white" fill-opacity="0.45"/>
// <path d="M101.119 377.618L98.3668 380.371C93.7998 384.938 89.4365 388.077 85.278 389.79C78.8765 392.441 72.1074 392.319 64.9709 389.423C63.0544 388.649 61.1379 387.608 59.2224 386.304C57.306 384.999 55.5523 383.551 53.9624 381.962C52.2087 380.208 50.7407 378.496 49.5582 376.824C48.3758 375.153 47.3561 373.194 46.5002 370.952C43.6051 363.817 43.4832 357.047 46.1328 350.645C47.8045 346.526 50.9454 342.163 55.5523 337.556L58.3047 334.804L66.8674 343.367L65.5212 344.713C62.5041 347.73 60.5467 349.851 59.6499 351.073C57.8553 353.519 56.8157 356.109 56.53 358.841C56.3672 360.39 56.4491 361.858 56.7747 363.244C57.1822 365.12 58.0181 366.934 59.2824 368.688L75.7357 352.235L83.6872 360.186L67.2339 376.64C68.9457 378.026 70.8631 378.963 72.9833 379.453C74.7779 379.861 76.5306 379.902 78.2434 379.576C80.7301 379.046 83.3815 377.577 86.1948 375.172C87.3354 374.193 88.6407 372.969 90.1087 371.501L92.5555 369.055L101.118 377.617L101.119 377.618Z" fill="white" fill-opacity="0.45"/>
// <path d="M98.1018 312.133L88.805 321.43L123.056 355.681L114.004 364.733L79.753 330.482L70.4562 339.779L61.8926 331.215L89.5381 303.57L98.1018 312.133Z" fill="white" fill-opacity="0.45"/>
// <path d="M165.258 313.478L156.206 322.53L140.915 307.239L131.619 316.536L123.056 307.973L132.353 298.677L128.193 294.517C125.992 292.316 123.77 291.113 121.527 290.909C119.284 290.705 117.225 291.54 115.348 293.417C113.473 295.292 112.637 297.352 112.842 299.594C113.045 301.837 114.247 304.06 116.449 306.262L144.462 334.275L135.41 343.327L107.948 315.865C102.892 310.809 100.364 305.345 100.364 299.473C100.364 294.008 102.504 289.135 106.786 284.854C110.986 280.654 115.838 278.534 121.343 278.493C127.255 278.452 132.739 280.961 137.796 286.017L165.257 313.479L165.258 313.478Z" fill="white" fill-opacity="0.45"/>
// <path d="M192.355 286.382L184.16 294.577C179.063 299.674 174.068 301.653 169.175 300.51C165.953 299.735 162.386 297.39 158.471 293.476L129.051 264.056L138.103 255.004L167.095 283.995C169.378 286.278 171.478 287.154 173.394 286.626C174.414 286.339 175.882 285.239 177.797 283.323L183.547 277.574L192.354 286.381L192.355 286.382Z" fill="white" fill-opacity="0.45"/>
// <path d="M333.255 129.162C335.782 131.689 337.342 133.616 337.954 134.961C339.136 137.612 338.587 140.079 336.303 142.363C334.02 144.646 331.063 145.442 327.444 144.759C326.017 144.474 324 143.883 321.389 142.986L285.415 130.743L315.997 161.325L306.945 170.377L270.98 134.412C268.982 132.414 267.698 130.6 267.128 128.969C266.108 126.074 266.883 123.342 269.451 120.773C271.572 118.653 273.978 117.593 276.669 117.592C278.3 117.593 280.889 118.184 284.437 119.366L316.304 130.315L288.841 102.852L297.893 93.7998L333.256 129.163L333.255 129.162Z" fill="white" fill-opacity="0.45"/>
// <path d="M371.961 105.358L369.209 108.11C364.642 112.677 360.278 115.816 356.12 117.53C349.718 120.18 342.949 120.059 335.813 117.162C333.896 116.388 331.98 115.348 330.064 114.044C328.148 112.738 326.394 111.291 324.804 109.701C323.051 107.948 321.582 106.236 320.4 104.564C319.218 102.892 318.198 100.934 317.342 98.6918C314.447 91.5562 314.325 84.7872 316.975 78.3847C318.646 74.2661 321.787 69.9029 326.394 65.296L329.146 62.5436L337.709 71.1063L336.363 72.4525C333.346 75.4695 331.389 77.5906 330.492 78.8131C328.697 81.2589 327.657 83.8485 327.372 86.5808C327.209 88.1298 327.291 89.5979 327.617 90.984C328.024 92.8596 328.86 94.6742 330.124 96.4279L346.577 79.9746L354.529 87.9261L338.076 104.379C339.787 105.766 341.705 106.702 343.825 107.193C345.62 107.601 347.372 107.642 349.085 107.315C351.572 106.786 354.223 105.317 357.037 102.911C358.177 101.933 359.482 100.709 360.951 99.2412L363.397 96.7944L371.96 105.357L371.961 105.358Z" fill="white" fill-opacity="0.45"/>
// <path d="M390.737 63.2179C393.102 65.5828 394.632 68.1314 395.324 70.8628C396.292 74.6243 395.905 78.1917 394.142 81.5867C393.041 83.7478 391.012 86.306 388.076 89.2421L375.752 101.566L367.189 93.0036L378.852 81.341C380.574 79.6188 381.676 78.2735 382.165 77.2948C383.072 75.4907 382.848 73.9198 381.502 72.5746C380.605 71.6778 379.423 71.1884 377.955 71.1065C377.017 71.0656 374.326 71.514 369.882 72.4527C365.152 73.4314 361.625 74.0626 359.3 74.3482C356.078 74.7157 353.427 74.6339 351.349 74.1036C348.658 73.4514 346.19 72.0043 343.947 69.7613C341.582 67.3964 340.093 64.725 339.482 61.7489C338.748 58.3225 339.176 55.1636 340.766 52.2694C341.827 50.312 343.824 47.8652 346.759 44.9301L357.831 33.8587L366.393 42.4214L354.65 54.1649C353.426 55.3883 352.672 56.346 352.387 57.0391C351.898 58.2625 352.163 59.384 353.183 60.4036C353.957 61.1777 354.976 61.6261 356.24 61.7489C357.259 61.8717 358.36 61.8717 359.542 61.7479C360.399 61.6261 362.356 61.2176 365.414 60.5245C370.265 59.3421 373.956 58.6081 376.485 58.3225C379.014 58.0369 381.194 58.1187 383.028 58.5671C384.375 58.8527 385.72 59.423 387.066 60.2799C388.411 61.1358 389.635 62.1154 390.735 63.216L390.737 63.2179Z" fill="white" fill-opacity="0.45"/>
// </svg>
// `;

// const watermark = Buffer.from(watermarkSVG); 

// export async function processImage(file: Blob) {
//   try {
//     const bufferData = await file.arrayBuffer();
//     const buffer = Buffer.from(bufferData);

//     const image = sharp(buffer);

//     const watermarkedImage = await image
//       .resize(800, 540) 
//       .composite([{
//         input: watermark, 
//         gravity: 'center' 
//       }])
//       .toBuffer();

//     return watermarkedImage;
//   } catch (error) {
//     console.error('Error processing image:', error);
//     throw error;
//   }
// }
import sharp from 'sharp';

const watermarkSVG = `
<svg width="430" height="430" viewBox="0 0 430 430" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M273.382 252.071C286.585 238.867 293.187 221.561 293.187 204.257C293.187 186.952 286.585 169.647 273.381 156.443C260.177 143.239 242.871 136.637 225.567 136.636C208.262 136.636 190.957 143.239 177.753 156.443C164.549 169.647 157.948 186.952 157.947 204.256C157.947 221.561 164.55 238.866 177.753 252.07C190.957 265.274 208.263 271.876 225.568 271.877C242.872 271.877 260.178 265.275 273.382 252.071ZM297.567 204.257C297.567 222.683 290.537 241.11 276.479 255.168C262.421 269.226 243.994 276.256 225.568 276.256C207.141 276.256 188.714 269.226 174.656 255.168C160.597 241.11 153.568 222.683 153.568 204.256C153.567 185.83 160.597 167.403 174.656 153.345C188.714 139.287 207.14 132.257 225.567 132.257C243.993 132.257 262.42 139.287 276.478 153.345C290.537 167.403 297.567 185.83 297.567 204.257Z" fill="white" fill-opacity="0.45"/>
<path d="M218.656 206.231L262.589 250.164C255.594 255.335 252.717 257.734 243.503 261.024L197.43 214.951L199.076 210.344L218.656 206.23L218.656 206.231Z" fill="white" fill-opacity="0.45"/>
<path d="M218.656 206.231L262.589 250.164C255.594 255.335 252.717 257.734 243.503 261.024L197.43 214.951L199.076 210.344L218.656 206.23L218.656 206.231Z" fill="white" fill-opacity="0.45"/>
<path d="M225.897 158.843L246.958 179.905L238.238 181.714L230.669 202.118L197.102 169.209L198.767 164.582L225.897 158.843Z" fill="white" fill-opacity="0.45"/>
<path d="M225.897 158.843L246.958 179.905L238.238 181.714L230.669 202.118L197.102 169.209L198.767 164.582L225.897 158.843Z" fill="white" fill-opacity="0.45"/>
<path d="M259.135 178.917L284.145 203.927C283.82 214.632 282.337 218.649 278.868 228.033L278.715 228.444L237.909 187.638L239.555 183.03L259.135 178.916L259.135 178.917Z" fill="white" fill-opacity="0.45"/>
<path d="M259.135 178.917L284.145 203.927C283.82 214.632 282.337 218.649 278.868 228.033L278.715 228.444L237.909 187.638L239.555 183.03L259.135 178.916L259.135 178.917Z" fill="white" fill-opacity="0.45"/>
<path d="M231.656 203.763L239.389 183.195L240.705 188.789L235.44 203.597L272.133 240.291C271.578 241.101 271.172 241.538 270.159 242.265L231.656 203.762L231.656 203.763Z" fill="white" fill-opacity="0.45"/>
<path d="M231.656 203.763L239.389 183.195L240.705 188.789L235.44 203.597L272.133 240.291C271.578 241.101 271.172 241.538 270.159 242.265L231.656 203.762L231.656 203.763Z" fill="white" fill-opacity="0.45"/>
<path d="M191.508 230.748L199.241 210.181L200.557 216.105L195.127 231.078L228.035 263.986C226.903 264.333 226.257 264.427 225.073 264.315L191.507 230.748L191.508 230.748Z" fill="white" fill-opacity="0.45"/>
<path d="M191.508 230.748L199.241 210.181L200.557 216.105L195.127 231.078L228.035 263.986C226.903 264.333 226.257 264.427 225.073 264.315L191.507 230.748L191.508 230.748Z" fill="white" fill-opacity="0.45"/>
<path d="M188.71 191.093L198.746 164.602L200.063 170.197L193.481 189.284L209.935 205.738L204.341 206.725L188.71 191.093Z" fill="white" fill-opacity="0.45"/>
<path d="M188.71 191.093L198.746 164.602L200.063 170.197L193.481 189.284L209.935 205.738L204.341 206.725L188.71 191.093Z" fill="white" fill-opacity="0.45"/>
<path d="M101.119 377.618L98.3668 380.371C93.7998 384.938 89.4365 388.077 85.278 389.79C78.8765 392.441 72.1074 392.319 64.9709 389.423C63.0544 388.649 61.1379 387.608 59.2224 386.304C57.306 384.999 55.5523 383.551 53.9624 381.962C52.2087 380.208 50.7407 378.496 49.5582 376.824C48.3758 375.153 47.3561 373.194 46.5002 370.952C43.6051 363.817 43.4832 357.047 46.1328 350.645C47.8045 346.526 50.9454 342.163 55.5523 337.556L58.3047 334.804L66.8674 343.367L65.5212 344.713C62.5041 347.73 60.5467 349.851 59.6499 351.073C57.8553 353.519 56.8157 356.109 56.53 358.841C56.3672 360.39 56.4491 361.858 56.7747 363.244C57.1822 365.12 58.0181 366.934 59.2824 368.688L75.7357 352.235L83.6872 360.186L67.2339 376.64C68.9457 378.026 70.8631 378.963 72.9833 379.453C74.7779 379.861 76.5306 379.902 78.2434 379.576C80.7301 379.046 83.3815 377.577 86.1948 375.172C87.3354 374.193 88.6407 372.969 90.1087 371.501L92.5555 369.055L101.118 377.617L101.119 377.618Z" fill="white" fill-opacity="0.45"/>
<path d="M98.1018 312.133L88.805 321.43L123.056 355.681L114.004 364.733L79.753 330.482L70.4562 339.779L61.8926 331.215L89.5381 303.57L98.1018 312.133Z" fill="white" fill-opacity="0.45"/>
<path d="M165.258 313.478L156.206 322.53L140.915 307.239L131.619 316.536L123.056 307.973L132.353 298.677L128.193 294.517C125.992 292.316 123.77 291.113 121.527 290.909C119.284 290.705 117.225 291.54 115.348 293.417C113.473 295.292 112.637 297.352 112.842 299.594C113.045 301.837 114.247 304.06 116.449 306.262L144.462 334.275L135.41 343.327L107.948 315.865C102.892 310.809 100.364 305.345 100.364 299.473C100.364 294.008 102.504 289.135 106.786 284.854C110.986 280.654 115.838 278.534 121.343 278.493C127.255 278.452 132.739 280.961 137.796 286.017L165.257 313.479L165.258 313.478Z" fill="white" fill-opacity="0.45"/>
<path d="M192.355 286.382L184.16 294.577C179.063 299.674 174.068 301.653 169.175 300.51C165.953 299.735 162.386 297.39 158.471 293.476L129.051 264.056L138.103 255.004L167.095 283.995C169.378 286.278 171.478 287.154 173.394 286.626C174.414 286.339 175.882 285.239 177.797 283.323L183.547 277.574L192.354 286.381L192.355 286.382Z" fill="white" fill-opacity="0.45"/>
<path d="M333.255 129.162C335.782 131.689 337.342 133.616 337.954 134.961C339.136 137.612 338.587 140.079 336.303 142.363C334.02 144.646 331.063 145.442 327.444 144.759C326.017 144.474 324 143.883 321.389 142.986L285.415 130.743L315.997 161.325L306.945 170.377L270.98 134.412C268.982 132.414 267.698 130.6 267.128 128.969C266.108 126.074 266.883 123.342 269.451 120.773C271.572 118.653 273.978 117.593 276.669 117.592C278.3 117.593 280.889 118.184 284.437 119.366L316.304 130.315L288.841 102.852L297.893 93.7998L333.256 129.163L333.255 129.162Z" fill="white" fill-opacity="0.45"/>
<path d="M371.961 105.358L369.209 108.11C364.642 112.677 360.278 115.816 356.12 117.53C349.718 120.18 342.949 120.059 335.813 117.162C333.896 116.388 331.98 115.348 330.064 114.044C328.148 112.738 326.394 111.291 324.804 109.701C323.051 107.948 321.582 106.236 320.4 104.564C319.218 102.892 318.198 100.934 317.342 98.6918C314.447 91.5562 314.325 84.7872 316.975 78.3847C318.646 74.2661 321.787 69.9029 326.394 65.296L329.146 62.5436L337.709 71.1063L336.363 72.4525C333.346 75.4695 331.389 77.5906 330.492 78.8131C328.697 81.2589 327.657 83.8485 327.372 86.5808C327.209 88.1298 327.291 89.5979 327.617 90.984C328.024 92.8596 328.86 94.6742 330.124 96.4279L346.577 79.9746L354.529 87.9261L338.076 104.379C339.787 105.766 341.705 106.702 343.825 107.193C345.62 107.601 347.372 107.642 349.085 107.315C351.572 106.786 354.223 105.317 357.037 102.911C358.177 101.933 359.482 100.709 360.951 99.2412L363.397 96.7944L371.96 105.357L371.961 105.358Z" fill="white" fill-opacity="0.45"/>
<path d="M390.737 63.2179C393.102 65.5828 394.632 68.1314 395.324 70.8628C396.292 74.6243 395.905 78.1917 394.142 81.5867C393.041 83.7478 391.012 86.306 388.076 89.2421L375.752 101.566L367.189 93.0036L378.852 81.341C380.574 79.6188 381.676 78.2735 382.165 77.2948C383.072 75.4907 382.848 73.9198 381.502 72.5746C380.605 71.6778 379.423 71.1884 377.955 71.1065C377.017 71.0656 374.326 71.514 369.882 72.4527C365.152 73.4314 361.625 74.0626 359.3 74.3482C356.078 74.7157 353.427 74.6339 351.349 74.1036C348.658 73.4514 346.19 72.0043 343.947 69.7613C341.582 67.3964 340.093 64.725 339.482 61.7489C338.748 58.3225 339.176 55.1636 340.766 52.2694C341.827 50.312 343.824 47.8652 346.759 44.9301L357.831 33.8587L366.393 42.4214L354.65 54.1649C353.426 55.3883 352.672 56.346 352.387 57.0391C351.898 58.2625 352.163 59.384 353.183 60.4036C353.957 61.1777 354.976 61.6261 356.24 61.7489C357.259 61.8717 358.36 61.8717 359.542 61.7479C360.399 61.6261 362.356 61.2176 365.414 60.5245C370.265 59.3421 373.956 58.6081 376.485 58.3225C379.014 58.0369 381.194 58.1187 383.028 58.5671C384.375 58.8527 385.72 59.423 387.066 60.2799C388.411 61.1358 389.635 62.1154 390.735 63.216L390.737 63.2179Z" fill="white" fill-opacity="0.45"/>
</svg>
`;
const watermark = Buffer.from(watermarkSVG); 

export async function processImage(file: Blob) {
  try {
    const bufferData = await file.arrayBuffer();
    const buffer = Buffer.from(bufferData);

    const image = sharp(buffer);

    // Получаем метаданные изображения для вычисления размеров
    const metadata = await image.metadata();

    // Проверяем, что размеры изображения доступны
    if (!metadata.width || !metadata.height) {
      throw new Error('Не удалось получить размеры изображения');
    }

    // Размеры изображения после ресайза (например, 800x540)
    const targetWidth = 800;
    const targetHeight = 540;

    // Пропорции для центральной обрезки
    const cropX = Math.floor((metadata.width - targetWidth) / 2);
    const cropY = Math.floor((metadata.height - targetHeight) / 2);

    const watermarkedImage = await image
      .resize(targetWidth, targetHeight)  
      .extract({ left: cropX, top: cropY, width: targetWidth, height: targetHeight })  
      .composite([{
        input: watermark, 
        gravity: 'center'  
      }])
      .toBuffer();

    return watermarkedImage;
  } catch (error) {
    console.error('Error processing image:', error);
    throw error;
  }
}
